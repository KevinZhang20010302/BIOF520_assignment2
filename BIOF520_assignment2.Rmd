---
title: "Final_BIOF520_Assignment2"
author: "Kevin Zhang"
date: "2026-02-04"
output: github_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(glmnet)
library(limma)
library(pROC)
library(rms)
library(survival)
library(survminer)
library(tidyverse)

knitr::opts_chunk$set(echo = TRUE)
```

### read data

```{r}
knowles <- readRDS("~/Documents/BIOF520/Assignment2/knowles_matched_TaLG_final.rds")
UROMOL <- readRDS("~/Documents/BIOF520/Assignment2/UROMOL_TaLG.teachingcohort.rds")

knowles_clinical <- knowles %>% select(knowles_ID,
                                       Age,
                                       Sex,
                                       Concomitant.CIS,
                                       UROMOL2021.classification,
                                       BCG,
                                       FUtime_days.,
                                       Recurrence,
                                       RFS_time
                                       ) 

UROMOL_clinical <- UROMOL %>% select(UROMOL.ID,
                                       Age,
                                       Sex,
                                       Concomitant.CIS,
                                       UROMOL2021.classification,
                                       BCG,
                                       FUtime_days.,
                                       Recurrence,
                                       RFS_time
                                       )

knowles_gene <- knowles$exprs
UROMOL_gene <- UROMOL$exprs
```


### remove batch effect (normalization for cross-platform (Microarray vs RNA-seq))
```{r}
knowles_gene_t <- t(knowles_gene) 
UROMOL_gene_t <- t(UROMOL_gene) #convert gene name to rkw

both_gene_name <- intersect(rownames(knowles_gene_t), rownames(UROMOL_gene_t))

knowles_UROMOL_gene_t <- cbind(knowles_gene_t[both_gene_name, ],
                               UROMOL_gene_t[both_gene_name, ])

knowles_UROMOL_batch <- c(rep("knowles", ncol(knowles_gene_t)), rep("UROMOL", ncol(UROMOL_gene_t)))

normalized_knowles_UROMOL_gene_t <- removeBatchEffect(knowles_UROMOL_gene_t, batch = knowles_UROMOL_batch)

normalized_knowles_gene_t <- normalized_knowles_UROMOL_gene_t[, knowles_UROMOL_batch == "knowles"]
normalized_UROMOL_gene_t <- normalized_knowles_UROMOL_gene_t[, knowles_UROMOL_batch == "UROMOL"]

normalized_knowles_gene <- t(normalized_knowles_gene_t)
normalized_UROMOL_gene <- t(normalized_UROMOL_gene_t)
```

### clean the clinical data based on survival data 
```{r}
### first convert RFS_time by FUtime_days/30 if recurrence is not null but RFS_time is null
knowles_index <- !is.na(knowles_clinical$Recurrence) & is.na(knowles_clinical$RFS_time)
knowles_clinical_final <- knowles_clinical
knowles_clinical_final$RFS_time[knowles_index] <- knowles_clinical_final$FUtime_days.[knowles_index] / 30

UROMOL_index <- !is.na(UROMOL_clinical$Recurrence) & is.na(UROMOL_clinical$RFS_time)
UROMOL_clinical_final <- UROMOL_clinical
UROMOL_clinical_final$RFS_time[UROMOL_index] <- UROMOL_clinical_final$FUtime_days.[UROMOL_index] / 30


### remove NA in both RFS and recurrence
remove_k_index <- is.na(knowles_clinical$Recurrence) & is.na(knowles_clinical$RFS_time)
knowles_clinical_final <- knowles_clinical_final[!remove_k_index, ]
keep_k_rows <- rownames(knowles_clinical_final)
knowles_gene_final <- normalized_knowles_gene[keep_k_rows, ]

remove_u_index <- is.na(UROMOL_clinical$Recurrence) & is.na(UROMOL_clinical$RFS_time)
UROMOL_clinical_final <- UROMOL_clinical_final[!remove_u_index, ]
keep_u_rows <- rownames(UROMOL_clinical_final)
UROMOL_gene_final <- normalized_UROMOL_gene[keep_u_rows, ]


```

### further clean clinical data
```{r}
knowles_clinical_final_final <- knowles_clinical_final %>%
  mutate(Sex = factor(Sex),
         Concomitant.CIS = factor(Concomitant.CIS, levels = c("No", "Yes")),
         UROMOL2021.classification = factor(UROMOL2021.classification, levels = c("Class_1", "Class_2a", "Class_2b", "Class_3"),
                                            labels = c("Class 1", "Class 2a", "Class 2b", "Class 3")),
         BCG = factor(BCG, levels = c("0", "1")),
         risk_classification = case_when(RFS_time > 24 ~ "low",
                                         RFS_time <= 24 & Recurrence == 1 ~ "high",
                                         RFS_time <= 24 & Recurrence == 0 ~ "unknown")
         )

UROMOL_clinical_final_final <- UROMOL_clinical_final %>%
  mutate(Sex = factor(Sex),
         Concomitant.CIS = factor(Concomitant.CIS),
         UROMOL2021.classification = factor(UROMOL2021.classification),
         BCG = factor(BCG),
         risk_classification = case_when(RFS_time > 24 ~ "low",
                                         RFS_time <= 24 & Recurrence == 1 ~ "high",
                                         RFS_time <= 24 & Recurrence == 0 ~ "unknown")
         )


  
```

### make the x variables (meanwhile remove NAs)
```{r}
X_clinical_k <- model.matrix(~ Age + Sex + Concomitant.CIS + UROMOL2021.classification + BCG, data = knowles_clinical_final_final)[,-1]

X_clinical_u <- model.matrix(~ Age + Sex + Concomitant.CIS + UROMOL2021.classification + BCG, data = UROMOL_clinical_final_final)[,-1]


keep_k_rows <- rownames(X_clinical_k)
knowles_clinical_remove_NA <- knowles_clinical_final_final[keep_k_rows,]
knowles_gene_keep <- knowles_gene_final[keep_k_rows, ]
knowles_full <- cbind(X_clinical_k, knowles_gene_keep)

keep_u_rows <- rownames(X_clinical_u)
UROMOL_clinical_remove_NA <- UROMOL_clinical_final_final[keep_u_rows,]
UROMOL_gene_keep <- UROMOL_gene_final[keep_u_rows, ]
UROMOL_full <- cbind(X_clinical_u, UROMOL_gene_keep)


```

### make the y variables 
```{r}
survival_data_k <- with(
  knowles_clinical_remove_NA,
  Surv(time = RFS_time, event = Recurrence)
)


survival_data_u <- with(
  UROMOL_clinical_remove_NA,
  Surv(time = RFS_time, event = Recurrence)
)
```

### train data and test data spilt
```{r}
set.seed(1234)
u_length <- nrow(X_clinical_u)

train_size <- floor(0.8 * u_length)

train_index <- sample(seq_len(u_length), size = train_size)


UROMOL_train <- UROMOL_full[train_index, ]
UROMOL_test <- UROMOL_full[-train_index, ]

UROMOL_survival_train <- survival_data_u[train_index]
UROMOL_survival_test <- survival_data_u[-train_index]


```




### cox model fit
```{r}
set.seed(1234)
cox_cv_fit <- cv.glmnet(
    x = UROMOL_train,
    y = UROMOL_survival_train,
    family = "cox",
    alpha = 1,
    nfold = 10
  )


cox_penalty <- glmnet(
  x = UROMOL_train,
  y = UROMOL_survival_train,
  family = "cox",
  alpha = 1,
  lambda = cox_cv_fit$lambda.min
)

U_train_risk_score<- predict(cox_penalty, newx = UROMOL_train, type = "link")

no_recurrence_model <- coxph(UROMOL_survival_train ~ U_train_risk_score)

coefficient_matrix <- as.matrix(coef(cox_penalty))
non_zero_coefficient <- rownames(coefficient_matrix)[coefficient_matrix!=0]
non_zero_coefficient 
```



###test on test data
```{r}
### test risk score prediction
U_test_risk_score<- predict(cox_penalty, newx = UROMOL_test, type = "link")
### classification

new_data_df <- data.frame(U_train_risk_score = as.numeric(U_test_risk_score))

U_test_prediction_curves <- survfit(no_recurrence_model, newdata = new_data_df)

U_test_24_month_probability <- summary(U_test_prediction_curves, times = 24)$surv

UROMOL_test_result_df <- as.data.frame(UROMOL_test)

UROMOL_test_result_df$predict_classification <- ifelse(as.numeric(U_test_24_month_probability) > 0.5, "low", "high")



```

### KM plot
```{r}

u_predict_classification <- UROMOL_test_result_df$predict_classification

km_curve <- survfit(UROMOL_survival_test ~ u_predict_classification)

km_plot <- ggsurvplot(km_curve,
                      data = data.frame(UROMOL_survival_test, u_predict_classification),
                      risk.table = TRUE,
                      pval = TRUE,
                      conf.int = TRUE,
                      palette = c("red", "blue"),
                      title = "Kaplan-Meier plot for internal test",
                      legend.labs = c("High Risk", "Low Risk"),
                      xlab = "Time (Months)",
                      ylab = "Probabilty Of No Recurrent",
                      font.title = 10,
                      font.subtitle = 10,
                      font.caption = 10,
                      font.x = 10,
                      font.y = 10,
                      font.tickslab = 10,
                      font.legend = 10,
                      risk.table.fontsize = 3.5)

km_plot
```
### c-index calculation for internal test
```{r}
flip_u_risk_score <- -1 * U_test_risk_score

u_test_c_index <- concordance(UROMOL_survival_test~ flip_u_risk_score)$concordance

u_test_c_index
```

### km of EAU risk classification
```{r}
test_rowname <- rownames(UROMOL_test)

EAU_test<- UROMOL[test_rowname,]$EAU.risk

EAU_no_na_index <- is.na(EAU_test)

EAU_test_remove_NA <- EAU_test[!EAU_no_na_index]

EAU_binary <- ifelse(EAU_test_remove_NA == "Low", "Low Risk", "High/Intermediate Risk")

UROMOL_survival_test_EAU <- UROMOL_survival_test[!EAU_no_na_index]

EAU_km_curve <-  survfit(UROMOL_survival_test_EAU  ~ EAU_binary)

EAU_km_plot <- ggsurvplot(EAU_km_curve,
                      data = data.frame(UROMOL_survival_test_EAU, EAU_binary),
                      risk.table = TRUE,
                      pval = TRUE,
                      conf.int = TRUE,
                      palette = c("red", "blue"),
                      title = "Kaplan-Meier plot for internal test EAU",
                      legend.labs = c("High/Intermediate Risk", "Low Risk"),
                      xlab = "Time (Months)",
                      ylab = "Probabilty Of No Recurrent",
                      font.title = 10,
                      font.subtitle = 10,
                      font.caption = 10,
                      font.x = 10,
                      font.y = 10,
                      font.tickslab = 10,
                      font.legend = 10,
                      risk.table.fontsize = 3.5)

EAU_km_plot
```

### AUC for my classification
```{r}
u_test_id <- rownames(UROMOL_test_result_df)

UROMOL_ground_truth <- UROMOL_clinical_final_final[u_test_id, ]$risk_classification

u_test_roc_data <- data.frame(
  ground_truth_risk = UROMOL_ground_truth,
  predicted_risk = UROMOL_test_result_df$predict_classification
)

u_test_roc_data_nounkown <- u_test_roc_data[u_test_roc_data$ground_truth_risk != "unknown", ]

u_test_roc_data_nounkown <- u_test_roc_data_nounkown %>% mutate(
  ground_truth_risk = ifelse(ground_truth_risk == "high", 1, 0),
  predicted_risk = ifelse(predicted_risk == "high", 1, 0),
)

u_test_roc <- roc(u_test_roc_data_nounkown$ground_truth_risk, u_test_roc_data_nounkown$predicted_risk)

roc_plot<-ggroc(u_test_roc, color = "black") +
  geom_abline(slope = 1, intercept = 1, linetype = "dashed", color = "grey")+
  theme_minimal() +
  labs(title = "ROC plot for new classification model",
       x = "False Positive Rate",
       y = "True Positive Rate") +
  annotate("text", x=0.3, y = 0.2, label = paste("AUC =", round(auc(u_test_roc), 2)), size = 6, color = "red") +
  theme(plot.title = element_text(hjust = 0.5, size = 10),
        text = element_text(size = 10),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 10))

roc_plot

```
### AUC for old classification
```{r}
UROMOL_ground_truth_EAU <- UROMOL_ground_truth[!EAU_no_na_index]


eau_u_test_roc_data <- data.frame(
  ground_truth_risk = UROMOL_ground_truth_EAU,
  predicted_risk = EAU_binary
)

eau_u_test_roc_data_nounkown <- eau_u_test_roc_data[eau_u_test_roc_data$ground_truth_risk != "unknown", ]

eau_u_test_roc_data_nounkown <- eau_u_test_roc_data_nounkown %>% mutate(
  ground_truth_risk = ifelse(ground_truth_risk == "high", 1, 0),
  predicted_risk = ifelse(predicted_risk == "High/Intermediate Risk", 1, 0),
)

eau_u_test_roc <- roc(eau_u_test_roc_data_nounkown$ground_truth_risk, eau_u_test_roc_data_nounkown$predicted_risk)

eau_roc_plot<-ggroc(eau_u_test_roc, color = "black") +
  geom_abline(slope = 1, intercept = 1, linetype = "dashed", color = "grey")+
  theme_minimal() +
  labs(title = "ROC plot for EAU classification model",
       x = "False Positive Rate",
       y = "True Positive Rate") +
  annotate("text", x=0.3, y = 0.2, label = paste("AUC =", round(auc(eau_u_test_roc), 2)), size = 6, color = "red") +
  theme(plot.title = element_text(hjust = 0.5, size = 10),
        text = element_text(size = 10),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 10))

eau_roc_plot

```
### external validation
```{r}
k_test_risk_score<- predict(cox_penalty, newx = knowles_full, type = "link")
### classification

new_data_df <- data.frame(U_train_risk_score = as.numeric(k_test_risk_score))

K_test_prediction_curves <- survfit(no_recurrence_model, newdata = new_data_df)

K_test_24_month_probability <- summary(K_test_prediction_curves, times = 24)$surv

knowles_test_result_df <- as.data.frame(knowles_full)

knowles_test_result_df$predict_classification <- ifelse(as.numeric(K_test_24_month_probability) > 0.5, "low", "high")
```

### km plot for external 
```{r}
k_predict_classification <- knowles_test_result_df$predict_classification

k_km_curve <- survfit(survival_data_k ~ k_predict_classification)

k_km_plot <- ggsurvplot(k_km_curve,
                      data = data.frame(survival_data_k, k_predict_classification),
                      risk.table = TRUE,
                      pval = TRUE,
                      conf.int = TRUE,
                      palette = c("red", "blue"),
                      title = "Kaplan-Meier plot for external test",
                      legend.labs = c("High Risk", "Low Risk"),
                      xlab = "Time (Months)",
                      ylab = "Probabilty Of No Recurrent",
                      font.title = 10,
                      font.subtitle = 10,
                      font.caption = 10,
                      font.x = 10,
                      font.y = 10,
                      font.tickslab = 10,
                      font.legend = 10,
                      risk.table.fontsize = 3.5)

k_km_plot
```

### c-index for external
```{r}
flip_k_risk_score <- -1 * k_test_risk_score

k_test_c_index <- concordance(survival_data_k~ flip_k_risk_score)$concordance

k_test_c_index
```

### ROC plot for external
```{r}
k_id <- rownames(knowles_test_result_df)

knowles_ground_truth <- knowles_clinical_final_final[k_id, ]$risk_classification

k_test_roc_data <- data.frame(
  ground_truth_risk = knowles_ground_truth,
  predicted_risk = knowles_test_result_df$predict_classification
)

k_test_roc_data_nounkown <- k_test_roc_data[k_test_roc_data$ground_truth_risk != "unknown", ]

k_test_roc_data_nounkown <- k_test_roc_data_nounkown %>% mutate(
  ground_truth_risk = ifelse(ground_truth_risk == "high", 1, 0),
  predicted_risk = ifelse(predicted_risk == "high", 1, 0),
)

k_test_roc <- roc(k_test_roc_data_nounkown$ground_truth_risk, k_test_roc_data_nounkown$predicted_risk)

k_roc_plot<-ggroc(k_test_roc, color = "black") +
  geom_abline(slope = 1, intercept = 1, linetype = "dashed", color = "grey")+
  theme_minimal() +
  labs(title = "ROC plot for new classification model",
       x = "False Positive Rate",
       y = "True Positive Rate") +
  annotate("text", x=0.3, y = 0.2, label = paste("AUC =", round(auc(k_test_roc), 2)), size = 6, color = "red") +
  theme(plot.title = element_text(hjust = 0.5, size = 10),
        text = element_text(size = 10),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 10))

k_roc_plot
```
```{r}
### package a final function
risk_classifer <- function(x, t, p) {
  risk_score <- predict(cox_penalty, newx = x, type = "link")
  new_data_df <- data.frame(U_train_risk_score = as.numeric(risk_score))
  prediction_curves <- survfit(no_recurrence_model, newdata = new_data_df)
  time_month_probability <- summary(prediction_curves, times = t)$surv
  result_df <- as.data.frame(x)
  result_df$predict_probability <- as.numeric(time_month_probability)
  result_df$predict_classification <- ifelse(as.numeric(time_month_probability) > p, "low", "high")
  return(result_df)
}
```

### test final packed model correct or not
```{r}
test_final_u <- risk_classifer(UROMOL_test, 24, 0.5)
test_final_k <- risk_classifer(knowles_full, 24, 0.5)
identical(test_final_u$predict_classification, UROMOL_test_result_df$predict_classification)
identical(test_final_k$predict_classification, knowles_test_result_df$predict_classification)

test_final_u$predict_probability
test_final_k$predict_probability
```

